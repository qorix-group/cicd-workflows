# *******************************************************************************
# Copyright (c) 2025 Contributors to the Eclipse Foundation
#
# See the NOTICE file(s) distributed with this work for additional
# information regarding copyright ownership.
#
# This program and the accompanying materials are made available under the
# terms of the Apache License Version 2.0 which is available at
# https://www.apache.org/licenses/LICENSE-2.0
#
# SPDX-License-Identifier: Apache-2.0
# *******************************************************************************

name: SCORE PR Checks

on:
  workflow_call:

jobs:
  bazel-module-name-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check MODULE.bazel and validate module name
        run: |
          # Check if MODULE.bazel exists
          if [ ! -f "MODULE.bazel" ]; then
            echo "ℹ️  MODULE.bazel file not found in repository root - skipping Bazel module validation"
            exit 0
          fi
          
          echo "✅ MODULE.bazel file found"

          # Extract module name from MODULE.bazel
          if ! MODULE_LINE=$(grep '^module(' MODULE.bazel | head -1); then
            echo "❌ No module declaration found in MODULE.bazel"
            exit 1
          fi

          # Extract the module name from the module() declaration
          MODULE_NAME=$(echo "$MODULE_LINE" | sed 's/^module([[:space:]]*name[[:space:]]*=[[:space:]]*"\([^"]*\)".*/\1/' | sed 's/^module([[:space:]]*"\([^"]*\)".*/\1/')

          # Alternative extraction method if the above doesn't work
          if [[ -z "$MODULE_NAME" || "$MODULE_NAME" == "$MODULE_LINE" ]]; then
            MODULE_NAME=$(echo "$MODULE_LINE" | grep -o '"[^"]*"' | head -1 | tr -d '"')
          fi

          echo "Found module name: $MODULE_NAME"

          # Validate against the required regex pattern
          if [[ ! "$MODULE_NAME" =~ ^score_[[:lower:]_]+$ ]]; then
            echo "❌ Invalid module name: $MODULE_NAME"
            echo "Module name must match the pattern: ^score_[[:lower:]_]+$"
            echo "  - Must start with 'score_'"
            echo "  - Must contain only lowercase letters and underscores after 'score_'"
            echo "Examples of valid names: score_cli, score_compose, score_web_api"
            exit 1
          fi

          echo "✅ Module name is valid: $MODULE_NAME"